<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>1418 DriverStation</title>
    <link rel="stylesheet" href="style.css">
    <script src="js/jquery.js"></script>
    <script src="js/d3.js"></script>
    <script src="/networktables/networktables.js"></script>
</head>

<body>
    <header>
        NetworkTables websocket:
        <span id="connectstate">Unknown state</span>
        <br>Robot:
        <span id="robotstate">Unknown state</span>
        <nav>
            <ul>
                <li class="active"><a href="UI_MainPage.html">Teleop</a></li>
                <li><a href="tuningPage.html">Tuning</a></li>
                <li><a href="autonomousSelection.html">Autonomous</a></li>
            </ul>
        </nav>
    </header>
    <article>
        <h1>Teleop</h1>
        <div class="settings"></div>
        <div>
            <input id="EncoderSlider" type="range" min="0" max="3" value="1" step="1" list="stepList">
            <datalist id="stepList">
              <option>0</option>
              <option>1</option>
              <option>2</option>
              <option>3</option>
            </datalist>
            <span id="encoderValueDisplaySpan">EncoderValue:1</span>

            <script>
                $("#EncoderSlider").change(function(){
                  var encoderVal=$("#EncoderSlider").val();
                  $("#encoderValueDisplaySpan").text("EncoderValue:"+encoderVal);
                  NetworkTables.setValue("EncoderSliderValue",encoderVal);
                });
                function startTheTimer() {  //reminder, find the networktables value, add networktables support
                    var d = new Date();

                    var mEnd = 2;
                    var sEnd = 30;
                    var x = document.getElementById("GameTimer");
                    for (var i = 0; i < 150; i++) {
                        sEnd = sEnd - 1;
                        if (sEnd < 0) {
                            sEnd = sEnd + 60;
                            mEnd = mEnd - 1;
                        }
                        x.innerHTML = mEnd + ":" + sEnd;
                    }
                }

            </script>
            <p id="GameTimer">GameTime:00:00</p>
        </div>
        <div class="verticalDivide">
            <!-- MAKE THE CSS REMINDER Top Divide -->
            <div class="CamTab">
                <img id="camOffline" class="webcam-img" src="img/CamFeedOffline.png">
                <!-- placeholderimage -->
            </div>
        </div>
        <div class="verticalDivide">
            <!-- MAKE THE CSS REMINDER Bottom Divide -->
            <div class="roboWidget">
                <!-- MAKE THE CSS REMINDER robowidget -->
                <svg id="widgetCanvas" width="250" height="150">
                    <rect id="robotBody" x="75" y="75" width="110" height="60" style="fill:rgb(155,155,155);stroke-width:3;stroke:rgb(0,0,0)" />
                    <rect id="robotArm" x="35" y="75" width="80" height="10" style="fill:rgb(195,125,195);stroke-width:3;stroke:rgb(0,0,0)" />
                    <circle id="ballWidget" cx="50" cy="110" r="20" stroke="black" stroke-width="3" style="fill:rgb(240,25,95);stroke-width:3;stroke:rgb(0,0,0)" visibility="hidden" />
                </svg>
            </div>
        </div>
        <div id="autoButtonDiv">
          <img id="gateButton" class="autoButton"src="/img/gate.jpg" activeState=false>
          <img id="chevyButton" class="autoButton" src="/img/cheval.gif" activeState=false>
          <img id="ladderButton" class="autoButton"src="/img/ladder.png" activeState=false>

        </div>
    </article>
    <script>
        $(document).ready(function() {
            // sets a function that will be called when the websocket connects/disconnects
            NetworkTables.addWsConnectionListener(onNetworkTablesConnection, true);
            // sets a function that will be called when the robot connects/disconnects
            NetworkTables.addRobotConnectionListener(onRobotConnection, true);
            // sets a function that will be called when any NetworkTables key/value changes
            NetworkTables.addGlobalListener(onValueChanged, true);

            $(".autoButton").click(function(){
              var $thisButton=$(this);
              var activeState=$thisButton.attr("activeState");
              if(activeState==true||activeState=="true"){
                activeState=false;
              }
              else if(activeState==false||activeState=="false"){
                activeState=true;
              }
              else{
                console.log("activeStateButtonBug");
              }
              NetworkTables.setValue($thisButton.attr("id"),activeState);      //onclick set the things id to true
            });

        });
        // called when the websocket connects/disconnects
        function onRobotConnection(connected) { // TODO: change some indicator
            //config.frontcam should be set to http://roborio-1418-frc.local:5800/
            //
            if (connected) {
                $('#camOffline').hide();

                $('#CamTab').prepend('<img class="webcamImage" id="webcamImage" src="' + "http://roborio-1418-frc.local:5800/" + '/?action=stream">');
            } else {
                $('#webcamImage').remove();

                $('#camOfflineImage').show();
            }
        }

        function onNetworkTablesConnection(connected) {
            // TODO: change some indicator
        }

        function onValueChanged(key, value, isNew) {
            if (isNew) {} else {
                // similarly, use keySelector to convert the key to a valid jQuery
                // selector. This should work for class names also, not just for ids
            }
            switch (key) {
                //raw arm value and is the ball in
                case "ballIn": //not the actual networktablesValue
                    if (value==true||value=="true") {                     //BOOLEANS ARE NOT WORKING WITH NETWORKTABLES AT THE MOMENT(or with testing at the very least)
                        $("#ballWidget").attr("visibility","visible");
                    } else if (value == false||value=="false") {
                        console.log("visibilityFalse");
                        $("#ballWidget").attr("visibility","hidden");
                    } else {
                        console.log("somethingisdefinitelyWrong")
                    }
                    break;
                case "Arm | Forward Limit Switch": //checkspelling
                    if (value == true) { //recheck valuetype, this should set it to 0 or max
                    }
                    break;
                case "Arm | Reverse Limit Switch":
                  if(value==true){//what is this supposed to do again?

                  }
                  break;
                case "Arm | Encoder":
                    if(value>1140){
                      value=1140;
                    }
                    else if(value<0){
                      value=0;
                    }
                    var $robotArm=$("#robotArm");
                    var rotationValue = -45 + value * 225 / 1140; //-45 plus value*225/1140, value between 0 and 1140
                    var rotationPointx=parseInt($robotArm.attr("width"))+parseInt($robotArm.attr("x"));
                    $robotArm.attr("transform", "rotate(" + rotationValue +" "+rotationPointx+" "+$robotArm.attr("y")+")");
                    break;
                case "chevyButton":
                case "gateButton":
                case "ladderButton":
                  //set the images border to something bright like orange if it equals true
                  //do acheck to see if all 4 are false, if so, then make them black border and slectable
                  var autoButtonSelection=$(".autoButton");

                  var buttonValueList=
                  autoButtonSelection.map(function(){return $(this).attr("activeState");}).get();
                  var isButtonActive=false;
                  var buttonValueListLength=buttonValueList.length;
                  for(var a=0;a< buttonValueListLength;a++){
                    if(buttonValueList[a]==true){           //==true is intended, was always returning true without the ==true
                      isButtonActive=true;
                    }
                  }
                  if(isButtonActive){

                  }
                  else{
                    autoButtonSelection.css({
                      "pointer-events": "auto",
                      "border-color":"black"
                    });
                  }

                  var setBorderColorTo="black";
                  $button=$("#"+key);
                  if(value==true ||value=="true"){      //string check is for testing purposes, remove later
                    setBorderColorTo="#ff66ff";
                    $button.attr("activeState",true);
                    $(".autoButton").not(document.getElementById(key)).each(function(){
                      /*in the event that one of them is true, check the other classes for true
                      if there is 2 trues then output a console and keep them both pink,
                      set all of the falses to unclickable and grayed out.
                      */var theNewButton=$(this);
                      theNewButton.css({
                        "pointer-events": "none",
                        "border-color":"#306860"
                      });
                    });
                  }
                  else if(value==false ||value=="false"){
                    $button.attr("activeState",false);
                  }
                  $button.css({"border-color":setBorderColorTo});

                  break;
              }
            }

    </script>
</body>

</html>
